- id: '1762596176562'
  alias: PIR → Man Cave Lights (until PIR clears)
  description: ''
  triggers:
  - trigger: state
    entity_id: binary_sensor.sonoff_1_occupancy
    to: 'on'
  actions:
  - data:
      reason: Motion in the atrium
    action: script.atrium_lights_on_reasoned
  - wait_for_trigger:
    - trigger: state
      entity_id: binary_sensor.sonoff_1_occupancy
      to: 'off'
    timeout: 02:00:00
    continue_on_timeout: false
  - data:
      reason: No motion for about one minute
    action: script.atrium_lights_off_reasoned
  mode: restart
- id: '1766787951743'
  alias: Front Bedroom Light auto OFF after 1 minute
  description: Single-device light auto-off test
  triggers:
  - entity_id: light.wall_dimmer_2
    to: 'on'
    trigger: state
  actions:
  - delay: 01:00:00
  - target:
      entity_id: light.wall_dimmer_2
    action: light.turn_off
  mode: restart
- id: '1767050394149'
  alias: Patio Light Bulb auto OFF after 5 minutes
  description: Single-device bulb auto-off test
  triggers:
  - entity_id: light.light_1
    to: 'on'
    trigger: state
  actions:
  - delay: 00:05:00
  - target:
      entity_id: light.light_1
    action: light.turn_off
  mode: restart
- id: '1767221347387'
  alias: Deercreek - PIR → Power Strip - TTS & Soundscape
  description: Turn ON power strip when motion detected, OFF 1 min after clear. TTS
    on ON, sound on OFF.
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    to: 'on'
    trigger: state
  - entity_id: binary_sensor.sonoff_1_occupancy
    to: 'off'
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
        action: switch.turn_on
      - target:
          entity_id: tts.google_translate_en_com
        data:
          media_player_entity_id: media_player.amp_1
          message: Motion detected.
        action: tts.speak
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - delay: 00:01:00
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      - target:
          entity_id: media_player.amp_1
        data:
          media:
            media_content_id: /local/soundscapes/1.wav
            media_content_type: music
            metadata: {}
        action: media_player.play_media
      - target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
        action: switch.turn_off
  mode: restart
- id: '1767221653083'
  alias: Deercreek - PIR → Power Strip
  description: Turn ON power strip when motion detected, OFF 1 min after clear.
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    to: 'on'
    trigger: state
  - entity_id: binary_sensor.sonoff_1_occupancy
    to: 'off'
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
        action: switch.turn_on
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - delay: 00:01:00
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      - target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
        action: switch.turn_off
  mode: restart
- id: '1767258109835'
  alias: Deercreek - TTS Alert - Samsung power state changed
  description: Speak when Samsung HA phone is plugged in or unplugged
  triggers:
  - entity_id: binary_sensor.sm_g965u_is_charging
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sm_g965u_is_charging
        state: 'on'
      sequence:
      - action: tts.speak
        target:
          entity_id: tts.google_translate_en_com
        data:
          media_player_entity_id: media_player.amp_1
          message: Power restored. The Home Assistant phone is now charging.
    - conditions:
      - condition: state
        entity_id: binary_sensor.sm_g965u_is_charging
        state: 'off'
      sequence:
      - action: tts.speak
        target:
          entity_id: tts.google_translate_en_com
        data:
          media_player_entity_id: media_player.amp_1
          message: Warning. The Home Assistant phone has been unplugged.
  mode: single
- id: '1767302308327'
  alias: Deercreek - PIR → Power Strip - TTS & Soundscape - Cool Down
  description: 'Single automation version. Motion ON: lights ON, TTS only if cooldown
    idle. Motion OFF: WAV only if cooldown idle, lights OFF, cooldown starts at end.

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - action: switch.turn_on
        target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown
            state: idle
          sequence:
          - action: tts.speak
            target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: media_player.amp_1
              message: Motion detected.
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown
            state: idle
          sequence:
          - action: media_player.play_media
            target:
              entity_id: media_player.amp_1
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
      - action: switch.turn_off
        target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
      - action: timer.start
        target:
          entity_id: timer.audio_cooldown
  mode: restart
- id: '1767307551834'
  alias: Deercreek - TTS – Speak Google Voice last notification (Multi-phone)
  description: 'Speak Google Voice notifications via TTS on amp_1.

    Phones: - Blackhawk: sensor.lm_q710_fgn_last_notification - Deercreek: sensor.sm_g965u_last_notification

    '
  triggers:
  - entity_id: sensor.sm_g965u_last_notification
    trigger: state
  conditions:
  - condition: template
    value_template: '{{ state_attr(n,''package'') == ''com.google.android.apps.googlevoice''
      }}

      '
  - condition: template
    value_template: "{{\n  (state_attr(n,'android.title') or '') | length > 0\n  or\n
      \ (state_attr(n,'android.text') or '') | length > 0\n}}\n"
  - condition: template
    value_template: "{{\n  (state_attr(n,'post_time') | string)\n  !=\n  states('input_text.last_google_voice_post_time_spoken')\n}}\n"
  actions:
  - variables:
      who: '{{ state_attr(n,''android.title'') or ''Message'' }}'
      txt: '{{ state_attr(n,''android.text'') or '''' }}'
      msg: '{{ who ~ '': '' ~ txt if txt|length > 0 else who ~ '': (no text)'' }}'
      pt: '{{ state_attr(n,''post_time'') or now().timestamp() | int }}'
  - target:
      entity_id: tts.google_translate_en_com
    data:
      media_player_entity_id: media_player.amp_1
      message: '{{ msg }}'
    action: tts.speak
  - target:
      entity_id: input_text.last_google_voice_post_time_spoken
    data:
      value: '{{ pt }}'
    action: input_text.set_value
  mode: single
  variables:
    phones:
      blackhawk: sensor.lm_q710_fgn_last_notification
      deercreek: sensor.sm_g965u_last_notification
    phone: '{{ phones.deercreek }}'
    n: '{{ phone }}'
- id: '1767321854973'
  alias: Deercreek - TTS - Google Voice - 7960 - S9
  description: "Google Voice notifications → TTS on amp_1.\nPhones: - Blackhawk: sensor.lm_q710_fgn_last_notification\n
    \         Deercreek S9: sensor.sm_g965u_last_notification\n          Deercreek
    Note9: sensor.sm_n960u_last_notification\n"
  triggers:
  - entity_id: sensor.sm_g965u_last_notification
    attribute: post_time
    trigger: state
  conditions:
  - condition: template
    value_template: '{{ trigger.entity_id == n }}

      '
  - condition: template
    value_template: '{{ state_attr(n,''package'') == ''com.google.android.apps.googlevoice''
      }}

      '
  actions:
  - variables:
      who: '{{ state_attr(n,''android.title'') or ''Google Voice'' }}'
      txt_raw: "{% set msgs = state_attr(n,'android.messages') %} {% if msgs is iterable
        and msgs|length > 0 and msgs[-1] is mapping and 'text' in msgs[-1] %}\n  {{
        msgs[-1].text }}\n{% else %}\n  {{ state_attr(n,'android.text') or '' }}\n{%
        endif %}"
      txt: "{{ txt_raw | replace('\n',' ') | replace('\r',' ') | trim | truncate(180,
        True, '…') }}"
  - condition: template
    value_template: '{{ txt|length > 0 }}'
  - action: tts.speak
    target:
      entity_id: tts.google_translate_en_com
    data:
      media_player_entity_id: media_player.amp_1
      message: '{{ prefix }}{{ who }}: {{ txt }}'
  mode: single
  variables:
    phones:
      blackhawk: sensor.lm_q710_fgn_last_notification
      deercreek_s9: sensor.sm_g965u_last_notification
      deercreek_note9: sensor.sm_n960u_last_notification
    selected: deercreek_s9
    n: '{{ phones[selected] }}'
    prefix: 'Laurie - {{ selected }}: '
- id: '1767328832669'
  alias: Deercreek - TTS - AT&T (Carrier) Phone - 2388 - Note9
  description: 'AT&T carrier phone events for Laurie on Samsung Galaxy Note 9.

    Note9 sensors: - Notifications: sensor.sm_n960u_last_notification - Phone state:  sensor.sm_n960u_phone_state

    This speaks: - Incoming call ringing (phone_state = ringing) - Carrier SMS texts
    from Samsung Messages app (package = com.samsung.android.messaging)

    '
  triggers:
  - entity_id: sensor.sm_n960u_phone_state
    trigger: state
  - entity_id: sensor.sm_n960u_last_notification
    attribute: post_time
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ trigger.entity_id == 'sensor.sm_n960u_phone_state'\n   and
          trigger.to_state is not none\n   and trigger.to_state.state == 'ringing'
          }}\n"
      sequence:
      - action: tts.speak
        target:
          entity_id: tts.google_translate_en_com
        data:
          media_player_entity_id: media_player.amp_1
          message: '{{ prefix }}Phone is ringing.'
    - conditions:
      - condition: template
        value_template: "{{ trigger.entity_id == 'sensor.sm_n960u_last_notification'\n
          \  and (state_attr('sensor.sm_n960u_last_notification','package') or '')\n
          \     == 'com.samsung.android.messaging' }}\n"
      sequence:
      - variables:
          n: sensor.sm_n960u_last_notification
          who: '{{ state_attr(n,''android.title'') or ''Text'' }}'
          txt_raw: "{% set msgs = state_attr(n,'android.messages') %} {% if msgs is
            iterable and msgs|length > 0 and msgs[-1] is mapping and 'text' in msgs[-1]
            %}\n  {{ msgs[-1].text }}\n{% else %}\n  {{ state_attr(n,'android.text')
            or '' }}\n{% endif %}"
          txt: "{{ txt_raw | replace('\n',' ') | replace('\r',' ') | trim | truncate(180,
            True, '…') }}"
      - condition: template
        value_template: '{{ txt|length > 0 }}'
      - action: tts.speak
        target:
          entity_id: tts.google_translate_en_com
        data:
          media_player_entity_id: media_player.amp_1
          message: '{{ prefix }}{{ who }}: {{ txt }}'
  mode: restart
  variables:
    phone_model: Note - 2388
    prefix: 'Laurie - {{ phone_model }}: '
- id: '1767332857490'
  alias: Deercreek - PIR → Power Strip - TTS & Soundscape - Cool Down (Speak previous
    motion)
  description: 'Motion ON: lights ON, speak the PREVIOUS motion time (from input_datetime.last_motion_time)
    only if cooldown is idle, then update helper to now. Motion OFF: WAV only if cooldown
    is idle, lights OFF, cooldown starts at end.

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - variables:
          prev_str: '{{ states(''input_datetime.last_motion_time'') }}'
          prev_ts: "{% set s = states('input_datetime.last_motion_time') %} {% if
            s not in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s)
            }}\n{% else %}\n  {{ none }}\n{% endif %}"
          prev_fmt: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
            %p', true) }}\n{% else %}\n  {{ 'no previous time saved' }}\n{% endif
            %}"
      - action: switch.turn_on
        target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown
            state: idle
          sequence:
          - action: tts.speak
            target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: media_player.amp_1
              message: "{% if prev_ts is not none %}\n  Previous motion was at {{
                prev_fmt }}.\n{% else %}\n  No previous motion time saved yet.\n{%
                endif %}"
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_motion_time
        data:
          date: '{{ now().strftime(''%Y-%m-%d'') }}'
          time: '{{ now().strftime(''%H:%M:%S'') }}'
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown
            state: idle
          sequence:
          - action: media_player.play_media
            target:
              entity_id: media_player.amp_1
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
      - action: switch.turn_off
        target:
          entity_id:
          - switch.power_1_switch_1
          - switch.power_1_switch_2
          - switch.power_1_switch_3
          - switch.power_1_switch_4
          - switch.power_1_switch_5
      - action: timer.start
        target:
          entity_id: timer.audio_cooldown
  mode: restart
- id: '1767838684489'
  alias: PIR → Light + Power Strip Group + Previous Motion TTS (24h date) + Cooldown
    - Whole Home
  description: 'Motion ON: turn ON target light + power strip group, speak PREVIOUS
    motion time only if cooldown idle. If previous motion was >= 24 hours ago, include
    the date. Then update last_motion_time_1 to now. Motion OFF: play WAV only if
    cooldown idle, then turn OFF light + power strip and start cooldown.

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_on
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_on
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_targets | length > 0 }}'
          sequence:
          - target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: '{{ audio_targets }}'
              message: "{% if prev_ts is none %}\n  No previous motion time saved
                yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p', true)
                }}.\n{% else %}\n  Previous motion was at {{ prev_time_only }}.\n{%
                endif %}"
            action: tts.speak
          - target:
              entity_id: timer.audio_cooldown_1
            action: timer.start
      - target:
          entity_id: input_datetime.last_motion_time_1
        data:
          date: '{{ now().strftime(''%Y-%m-%d'') }}'
          time: '{{ now().strftime(''%H:%M:%S'') }}'
        action: input_datetime.set_datetime
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_targets | length > 0 }}'
          sequence:
          - target:
              entity_id: '{{ audio_targets }}'
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
            action: media_player.play_media
          - target:
              entity_id: timer.audio_cooldown_1
            action: timer.start
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_off
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_off
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_choice: '{{ states(''input_select.audio_target_1'') }}'
    audio_targets: "{% set c = states('input_select.audio_target_1') %} {% if c ==
      'amp_all' %}\n  {{ states.media_player\n     | selectattr('entity_id', 'match',
      '^media_player\\\\.amp_')\n     | rejectattr('state', 'in', ['unavailable','unknown'])\n
      \    | map(attribute='entity_id')\n     | list }}\n{% elif c in ['unknown','unavailable','none','']
      %}\n  {{ [] }}\n{% else %}\n  {{ [c] }}\n{% endif %}"
    prev_ts: "{% set s = states('input_datetime.last_motion_time_1') %} {% if s not
      in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s) }}\n{% else
      %}\n  {{ none }}\n{% endif %}"
    hours_since_prev: "{% if prev_ts is not none %}\n  {{ ((as_timestamp(now()) -
      (prev_ts | float)) / 3600) | float(0) }}\n{% else %}\n  {{ 0 }}\n{% endif %}"
    prev_time_only: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
      %p', true) }}\n{% else %}\n  no previous time saved\n{% endif %}"
  mode: restart
- id: '1767857487798'
  alias: PIR → Light + Power Strip Group + Previous Motion TTS (24h date) + Cooldown
    - Whole Home - off
  description: 'Motion ON: turn ON target light + power strip group, speak PREVIOUS
    motion time only if cooldown idle. If previous motion was >= 24 hours ago, include
    the date. Then update last_motion_time_1 to now. Motion OFF: play WAV only if
    cooldown idle, then turn OFF light + power strip and start cooldown.

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_on
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_on
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_targets | length > 0 }}'
          sequence:
          - target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: '{{ audio_targets }}'
              message: "{% if prev_ts is none %}\n  No previous motion time saved
                yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p', true)
                }}.\n{% else %}\n  Previous motion was at {{ prev_time_only }}.\n{%
                endif %}"
            action: tts.speak
          - target:
              entity_id: timer.audio_cooldown_1
            action: timer.start
      - target:
          entity_id: input_datetime.last_motion_time_1
        data:
          date: '{{ now().strftime(''%Y-%m-%d'') }}'
          time: '{{ now().strftime(''%H:%M:%S'') }}'
        action: input_datetime.set_datetime
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_targets | length > 0 }}'
          sequence:
          - target:
              entity_id: '{{ audio_targets }}'
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
            action: media_player.play_media
          - target:
              entity_id: timer.audio_cooldown_1
            action: timer.start
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_off
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_off
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_choice: '{{ states(''input_select.audio_target_1'') }}'
    audio_targets: "{% set c = states('input_select.audio_target_1') %}\n{% if c in
      ['off','unknown','unavailable','none', 'None',''] %}\n  {{ [] }}\n{% elif c
      in ['All', 'all', 'amp_all', '*'] %}\n  {{ states.media_player\n     | selectattr('entity_id',
      'match', '^media_player\\\\.amp_')\n     | rejectattr('state', 'in', ['unavailable','unknown'])\n
      \    | map(attribute='entity_id')\n     | list }}\n{% else %}\n  {{ [c] }}\n{%
      endif %}"
    prev_ts: "{% set s = states('input_datetime.last_motion_time_1') %} {% if s not
      in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s) }}\n{% else
      %}\n  {{ none }}\n{% endif %}"
    hours_since_prev: "{% if prev_ts is not none %}\n  {{ ((as_timestamp(now()) -
      (prev_ts | float)) / 3600) | float(0) }}\n{% else %}\n  {{ 0 }}\n{% endif %}"
    prev_time_only: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
      %p', true) }}\n{% else %}\n  no previous time saved\n{% endif %}"
  mode: restart
- id: '1767933211351'
  alias: PIR → Light - day light (audio always)
  description: 'Motion ON: optionally turn ON target light (blocked during daylight
    if helper enabled), ALWAYS turn ON power strip group, ALWAYS speak previous motion
    time, then update last_motion_time_1. Motion OFF: play WAV, then turn OFF light
    + power strip.

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          - condition: template
            value_template: "{{ is_state('input_boolean.block_light_daytime_1','off')\n
              \  or is_state('sun.sun','below_horizon') }}"
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_on
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_on
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ audio_targets | length > 0 }}'
          sequence:
          - target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: '{{ audio_targets }}'
              message: "{% if prev_ts is none %}\n  No previous motion time saved
                yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p', true)
                }}.\n{% else %}\n  Previous motion was at {{ prev_time_only }}.\n{%
                endif %}"
            action: tts.speak
      - target:
          entity_id: input_datetime.last_motion_time_1
        data:
          date: '{{ now().strftime(''%Y-%m-%d'') }}'
          time: '{{ now().strftime(''%H:%M:%S'') }}'
        action: input_datetime.set_datetime
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ audio_targets | length > 0 }}'
          sequence:
          - target:
              entity_id: '{{ audio_targets }}'
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
            action: media_player.play_media
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_off
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_off
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_choice: '{{ states(''input_select.audio_target_1'') }}'
    audio_targets: "{% set c = states('input_select.audio_target_1') %} {% if c in
      ['off','unknown','unavailable','none','None',''] %}\n  {{ [] }}\n{% elif c in
      ['All', 'all', 'amp_all', '*'] %}\n  {{ states.media_player\n     | selectattr('entity_id',
      'match', '^media_player\\\\.amp_')\n     | rejectattr('state', 'in', ['unavailable','unknown'])\n
      \    | map(attribute='entity_id')\n     | list }}\n{% else %}\n  {{ [c] }}\n{%
      endif %}"
    prev_ts: "{% set s = states('input_datetime.last_motion_time_1') %} {% if s not
      in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s) }}\n{% else
      %}\n  {{ none }}\n{% endif %}"
    hours_since_prev: "{% if prev_ts is not none %}\n  {{ ((as_timestamp(now()) -
      (prev_ts | float)) / 3600) | float(0) }}\n{% else %}\n  {{ 0 }}\n{% endif %}"
    prev_time_only: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
      %p', true) }}\n{% else %}\n  no previous time saved\n{% endif %}"
  mode: restart
- id: '1767994727558'
  alias: PIR → Light (daylight blocks) + Power Strip + Prev Motion + Cooldown (starts
    after clear) - no amp selection
  description: 'Motion ON: Light turns on only if NOT daylight-blocked; power strip
    ON; TTS speaks PREVIOUS motion time only if cooldown is idle; update last_motion_time_1
    to now. IMPORTANT: cooldown does NOT start on ON. It only starts after PIR clears
    (OFF). Motion OFF: after 1 min still-off, play WAV only if cooldown is idle; then
    turn off light + power strip; start cooldown at the very end (only if WAV played).

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          - condition: template
            value_template: "{{ is_state('input_boolean.block_light_daytime_1','off')\n
              \  or is_state('sun.sun','below_horizon') }}"
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_on
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_on
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_target != ''none'' }}'
          sequence:
          - target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: '{{ audio_target }}'
              message: "{% if prev_ts is none %}\n  No previous motion time saved
                yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p', true)
                }}.\n{% else %}\n  Previous motion was at {{ prev_time_only }}.\n{%
                endif %}"
            action: tts.speak
      - target:
          entity_id: input_datetime.last_motion_time_1
        data:
          date: '{{ now().strftime(''%Y-%m-%d'') }}'
          time: '{{ now().strftime(''%H:%M:%S'') }}'
        action: input_datetime.set_datetime
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - delay: 00:01:00
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      - variables:
          did_wav: false
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_target != ''none'' }}'
          sequence:
          - target:
              entity_id: '{{ audio_target }}'
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
            action: media_player.play_media
          - variables:
              did_wav: true
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_off
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_off
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ did_wav }}'
          sequence:
          - target:
              entity_id: timer.audio_cooldown_1
            action: timer.start
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_target: "{% set c = states('input_select.audio_target_1') %} {% if c in
      ['off','unknown','unavailable','none','None',''] %}\n  none\n{% elif c in ['All','all','amp_all','*']
      %}\n  media_player.amp_1\n{% else %}\n  {{ c }}\n{% endif %}"
    prev_ts: "{% set s = states('input_datetime.last_motion_time_1') %} {% if s not
      in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s) }}\n{% else
      %}\n  {{ none }}\n{% endif %}"
    hours_since_prev: "{% if prev_ts is not none %}\n  {{ ((as_timestamp(now()) -
      (prev_ts | float)) / 3600) | float(0) }}\n{% else %}\n  {{ 0 }}\n{% endif %}"
    prev_time_only: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
      %p', true) }}\n{% else %}\n  no previous time saved\n{% endif %}"
  mode: restart
- id: '1767996447953'
  alias: PIR → Light (daylight blocks) + Power Strip + Prev Motion + Cooldown + Amp
    Select
  description: 'Motion ON: Light turns on only if NOT daylight-blocked; power strip
    ON; TTS speaks PREVIOUS motion only if cooldown idle; update last_motion_time_1.
    Cooldown starts ONLY after PIR clears (OFF) and only if WAV played.

    '
  triggers:
  - entity_id: binary_sensor.sonoff_1_occupancy
    trigger: state
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'on'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          - condition: template
            value_template: "{{ is_state('input_boolean.block_light_daytime_1','off')\n
              \  or is_state('sun.sun','below_horizon') }}"
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_on
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_on
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_choice not in [''off'',''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          sequence:
          - choose:
            - conditions:
              - condition: template
                value_template: '{{ audio_choice in [''amp_all'',''All'',''all'',''*'']
                  }}'
              sequence:
              - target:
                  entity_id: tts.google_translate_en_com
                data:
                  media_player_entity_id: media_player.amp_1
                  message: "{% if prev_ts is none %}\n  No previous motion time saved
                    yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was
                    on\n  {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M
                    %p', true) }}.\n{% else %}\n  Previous motion was at {{ prev_time_only
                    }}.\n{% endif %}"
                action: tts.speak
              - target:
                  entity_id: tts.google_translate_en_com
                data:
                  media_player_entity_id: media_player.amp_2
                  message: "{% if prev_ts is none %}\n  No previous motion time saved
                    yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was
                    on\n  {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M
                    %p', true) }}.\n{% else %}\n  Previous motion was at {{ prev_time_only
                    }}.\n{% endif %}"
                action: tts.speak
            default:
            - target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: '{{ audio_choice }}'
                message: "{% if prev_ts is none %}\n  No previous motion time saved
                  yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                  \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p',
                  true) }}.\n{% else %}\n  Previous motion was at {{ prev_time_only
                  }}.\n{% endif %}"
              action: tts.speak
      - target:
          entity_id: input_datetime.last_motion_time_1
        data:
          date: '{{ now().strftime(''%Y-%m-%d'') }}'
          time: '{{ now().strftime(''%H:%M:%S'') }}'
        action: input_datetime.set_datetime
    - conditions:
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      sequence:
      - delay: 00:01:00
      - condition: state
        entity_id: binary_sensor.sonoff_1_occupancy
        state: 'off'
      - variables:
          did_wav: false
      - choose:
        - conditions:
          - condition: state
            entity_id: timer.audio_cooldown_1
            state: idle
          - condition: template
            value_template: '{{ audio_choice not in [''off'',''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          sequence:
          - choose:
            - conditions:
              - condition: template
                value_template: '{{ audio_choice in [''amp_all'',''All'',''all'',''*'']
                  }}'
              sequence:
              - target:
                  entity_id: media_player.amp_1
                data:
                  media:
                    media_content_id: /local/soundscapes/1.wav
                    media_content_type: music
                    metadata: {}
                action: media_player.play_media
              - target:
                  entity_id: media_player.amp_2
                data:
                  media:
                    media_content_id: /local/soundscapes/1.wav
                    media_content_type: music
                    metadata: {}
                action: media_player.play_media
              - variables:
                  did_wav: true
            default:
            - target:
                entity_id: '{{ audio_choice }}'
              data:
                media:
                  media_content_id: /local/soundscapes/1.wav
                  media_content_type: music
                  metadata: {}
              action: media_player.play_media
            - variables:
                did_wav: true
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
              }}'
          sequence:
          - target:
              entity_id: '{{ target_light }}'
            action: light.turn_off
      - target:
          entity_id: group.power_strip_1
        action: homeassistant.turn_off
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ did_wav }}'
          sequence:
          - target:
              entity_id: timer.audio_cooldown_1
            action: timer.start
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_choice: '{{ states(''input_select.audio_target_1'') }}'
    prev_ts: "{% set s = states('input_datetime.last_motion_time_1') %} {% if s not
      in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s) }}\n{% else
      %}\n  {{ none }}\n{% endif %}"
    hours_since_prev: "{% if prev_ts is not none %}\n  {{ ((as_timestamp(now()) -
      (prev_ts | float)) / 3600) | float(0) }}\n{% else %}\n  {{ 0 }}\n{% endif %}"
    prev_time_only: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
      %p', true) }}\n{% else %}\n  no previous time saved\n{% endif %}"
  mode: restart
- id: '1768001884284'
  alias: PIR Guardian - ON (Light + Strip + Prev Motion TTS)
  description: 'PIR ON: Light turns on only if not daylight-blocked. Power strip always
    on. Speak PREVIOUS motion time only if cooldown is idle. Update last_motion_time_1.

    '
  triggers:
  - trigger: state
    entity_id: binary_sensor.sonoff_1_occupancy
    to: 'on'
  actions:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
          }}'
      - condition: template
        value_template: "{{ is_state('input_boolean.block_light_daytime_1','off')\n
          \  or is_state('sun.sun','below_horizon') }}"
      sequence:
      - action: light.turn_on
        target:
          entity_id: '{{ target_light }}'
  - action: homeassistant.turn_on
    target:
      entity_id: group.power_strip_1
  - choose:
    - conditions:
      - condition: state
        entity_id: timer.audio_cooldown_1
        state: idle
      - condition: template
        value_template: '{{ audio_choice not in [''off'',''unknown'',''unavailable'',''none'',''None'','''']
          }}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ audio_choice in [''amp_all'',''All'',''all'',''*'']
              }}'
          sequence:
          - action: tts.speak
            target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: media_player.amp_1
              message: "{% if prev_ts is none %}\n  No previous motion time saved
                yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p', true)
                }}.\n{% else %}\n  Previous motion was at {{ prev_time_only }}.\n{%
                endif %}"
          - action: tts.speak
            target:
              entity_id: tts.google_translate_en_com
            data:
              media_player_entity_id: media_player.amp_2
              message: "{% if prev_ts is none %}\n  No previous motion time saved
                yet.\n{% elif hours_since_prev >= 24 %}\n  Previous motion was on\n
                \ {{ (prev_ts | float) | timestamp_custom('%B %-d at %-I:%M %p', true)
                }}.\n{% else %}\n  Previous motion was at {{ prev_time_only }}.\n{%
                endif %}"
        default:
        - action: tts.speak
          target:
            entity_id: tts.google_translate_en_com
          data:
            media_player_entity_id: '{{ audio_choice }}'
            message: "{% if prev_ts is none %}\n  No previous motion time saved yet.\n{%
              elif hours_since_prev >= 24 %}\n  Previous motion was on\n  {{ (prev_ts
              | float) | timestamp_custom('%B %-d at %-I:%M %p', true) }}.\n{% else
              %}\n  Previous motion was at {{ prev_time_only }}.\n{% endif %}"
  - action: input_datetime.set_datetime
    target:
      entity_id: input_datetime.last_motion_time_1
    data:
      date: '{{ now().strftime(''%Y-%m-%d'') }}'
      time: '{{ now().strftime(''%H:%M:%S'') }}'
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_choice: '{{ states(''input_select.audio_target_1'') }}'
    prev_ts: "{% set s = states('input_datetime.last_motion_time_1') %} {% if s not
      in ['unknown','unavailable','none',''] %}\n  {{ as_timestamp(s) }}\n{% else
      %}\n  {{ none }}\n{% endif %}"
    hours_since_prev: "{% if prev_ts is not none %}\n  {{ ((as_timestamp(now()) -
      (prev_ts | float)) / 3600) | float(0) }}\n{% else %}\n  {{ 0 }}\n{% endif %}"
    prev_time_only: "{% if prev_ts is not none %}\n  {{ (prev_ts | float) | timestamp_custom('%-I:%M
      %p', true) }}\n{% else %}\n  no previous time saved\n{% endif %}"
  mode: restart
- id: '1768001926130'
  alias: PIR Guardian - OFF (Confirm Clear + WAV + Shutdown + Cooldown)
  description: 'PIR OFF: wait 1 minute and confirm still off. If cooldown is idle,
    play WAV. Then turn off light + power strip. Start cooldown ONLY at the end and
    ONLY if WAV played.

    '
  triggers:
  - trigger: state
    entity_id: binary_sensor.sonoff_1_occupancy
    to: 'off'
  actions:
  - delay: 00:01:00
  - condition: state
    entity_id: binary_sensor.sonoff_1_occupancy
    state: 'off'
  - variables:
      did_wav: false
  - choose:
    - conditions:
      - condition: state
        entity_id: timer.audio_cooldown_1
        state: idle
      - condition: template
        value_template: '{{ audio_choice not in [''off'',''unknown'',''unavailable'',''none'',''None'','''']
          }}'
      sequence:
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ audio_choice in [''amp_all'',''All'',''all'',''*'']
              }}'
          sequence:
          - action: media_player.play_media
            target:
              entity_id: media_player.amp_1
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
          - action: media_player.play_media
            target:
              entity_id: media_player.amp_2
            data:
              media:
                media_content_id: /local/soundscapes/1.wav
                media_content_type: music
                metadata: {}
          - variables:
              did_wav: true
        default:
        - action: media_player.play_media
          target:
            entity_id: '{{ audio_choice }}'
          data:
            media:
              media_content_id: /local/soundscapes/1.wav
              media_content_type: music
              metadata: {}
        - variables:
            did_wav: true
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ target_light not in [''unknown'',''unavailable'',''none'',''None'','''']
          }}'
      sequence:
      - action: light.turn_off
        target:
          entity_id: '{{ target_light }}'
  - action: homeassistant.turn_off
    target:
      entity_id: group.power_strip_1
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ did_wav }}'
      sequence:
      - action: timer.start
        target:
          entity_id: timer.audio_cooldown_1
  variables:
    target_light: '{{ states(''input_select.target_light_1'') }}'
    audio_choice: '{{ states(''input_select.audio_target_1'') }}'
  mode: single
