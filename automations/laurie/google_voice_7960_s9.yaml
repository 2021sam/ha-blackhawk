- id: '1767321854973'
  alias: Deercreek - TTS - Google Voice - 7960 - S9
  description: >
    Google Voice notifications → TTS on amp_1.
    Phones:
    - Blackhawk: sensor.lm_q710_fgn_last_notification
    - Deercreek S9: sensor.sm_g965u_last_notification
    - Deercreek Note9: sensor.sm_n960u_last_notification
  triggers:
    - entity_id: sensor.sm_g965u_last_notification
      attribute: post_time
      trigger: state
  conditions:
    - condition: template
      value_template: >
        {{ trigger.entity_id == n }}
    - condition: template
      value_template: >
        {{ state_attr(n,'package') == 'com.google.android.apps.googlevoice' }}
  actions:
    - variables:
        who: "{{ state_attr(n,'android.title') or 'Google Voice' }}"
        txt_raw: >
          {% set msgs = state_attr(n,'android.messages') %}
          {% if msgs is iterable and msgs|length > 0 and msgs[-1] is mapping and 'text' in msgs[-1] %}
            {{ msgs[-1].text }}
          {% else %}
            {{ state_attr(n,'android.text') or '' }}
          {% endif %}
        txt: "{{ txt_raw | replace('\n',' ') | replace('\r',' ') | trim | truncate(180, True, '…') }}"
    - condition: template
      value_template: "{{ txt|length > 0 }}"
    - action: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.amp_1
        message: "{{ prefix }}{{ who }}: {{ txt }}"
  mode: single
  variables:
    phones:
      blackhawk: sensor.lm_q710_fgn_last_notification
      deercreek_s9: sensor.sm_g965u_last_notification
      deercreek_note9: sensor.sm_n960u_last_notification
    selected: deercreek_s9
    n: "{{ phones[selected] }}"
    prefix: "Laurie - {{ selected }}: "
