- id: '1767321854973'
  alias: Google Voice - Phone 1 - new
  description: >
    Google Voice notifications → TTS on amp_1.
  triggers:
    - entity_id: sensor.phone_1_google_voice_last_notification
      attribute: post_time
      trigger: state
  conditions:
    - condition: template
      value_template: >
        {{ state_attr(n,'package') == 'com.google.android.apps.googlevoice' }}
  actions:
    - variables:
        who: "{{ state_attr(n,'android.title') or 'Google Voice' }}"
        txt_raw: >
          {% set msgs = state_attr(n,'android.messages') %}
          {% if msgs is iterable and msgs|length > 0 and msgs[-1] is mapping and 'text' in msgs[-1] %}
            {{ msgs[-1].text }}
          {% else %}
            {{ state_attr(n,'android.text') or '' }}
          {% endif %}
        txt: "{{ txt_raw | replace('\n',' ') | replace('\r',' ') | trim | truncate(180, True, '…') }}"
    - condition: template
      value_template: "{{ txt|length > 0 }}"
    - action: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.amp_1
        message: "{{ prefix }}{{ who }}: {{ txt }}"
  mode: single
  variables:
    n: sensor.phone_1_google_voice_last_notification
    prefix: "Phone 1 Google Voice: "
