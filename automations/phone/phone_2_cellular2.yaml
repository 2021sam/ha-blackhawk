- id: '1767329000002'
  alias: Phone 2 - Cellular - TTS
  mode: restart

  variables:
    prefix: "Phone 2 Cellular: "
    speaker: media_player.amp_1
    phone_state: sensor.phone_2_phone_state
    n: sensor.phone_2_last_notification

  trigger:
    - platform: state
      entity_id: sensor.phone_2_phone_state
    - platform: state
      entity_id: sensor.phone_2_last_notification

  action:
    - choose:

        # ğŸ“ Incoming call (Samsung-safe)
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.entity_id == phone_state
                   and trigger.to_state is not none
                   and trigger.to_state.state in ['ringing','incoming','offhook'] }}
          sequence:
            - action: tts.speak
              target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: "{{ speaker }}"
                message: "{{ prefix }}Phone is ringing."

        # ğŸ“© Cellular SMS (robust)
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.entity_id == n
                   and trigger.to_state is not none
                   and 'android' in trigger.to_state.attributes }}
          sequence:
            - variables:
                who: "{{ trigger.to_state.attributes.get('android.title','Text') }}"
                txt_raw: >
                  {% set msgs = trigger.to_state.attributes.get('android.messages') %}
                  {% if msgs is iterable and msgs|length > 0 and 'text' in msgs[-1] %}
                    {{ msgs[-1].text }}
                  {% else %}
                    {{ trigger.to_state.attributes.get('android.text','') }}
                  {% endif %}
                txt: "{{ txt_raw | replace('\n',' ') | trim }}"
            - condition: template
              value_template: "{{ txt|length > 0 }}"
            - action: tts.speak
              target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: "{{ speaker }}"
                message: "{{ prefix }}{{ who }}: {{ txt }}"
