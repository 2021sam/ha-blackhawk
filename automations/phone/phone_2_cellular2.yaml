- id: '1767329000002'
  alias: Laurie - Phone 2 - Cellular - TTS (Phone-Specific)
  description: >
    Phone 2 cellular events for Laurie.

    Sensors:
    - Notifications: sensor.phone_2_last_notification
    - Phone state:  sensor.phone_2_phone_state

    Speaks:
    - Incoming call
    - SMS texts (package filtered; body extracted from multiple fields)
  mode: restart

  variables:
    phone_model: "Phone 2"
    prefix: "Laurie - {{ phone_model }}: "
    speaker: media_player.amp_1

    phone_state: sensor.phone_2_phone_state
    n: sensor.phone_2_last_notification

    # We'll allow both common SMS apps; we'll also DEBUG the real one.
    sms_packages:
      - com.samsung.android.messaging
      - com.google.android.apps.messaging

  trigger:
    - platform: state
      entity_id: sensor.phone_2_phone_state

    # IMPORTANT: different phones update differently, so we cover both
    - platform: state
      entity_id: sensor.phone_2_last_notification
    - platform: state
      entity_id: sensor.phone_2_last_notification
      attribute: post_time

  action:
    - choose:

        # ğŸ“ Incoming call
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.entity_id == phone_state
                   and trigger.to_state is not none
                   and trigger.to_state.state in ['ringing','incoming','offhook'] }}
          sequence:
            - action: tts.speak
              target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: "{{ speaker }}"
                message: "{{ prefix }}Phone is ringing."

        # ğŸ“© SMS (phone-specific)
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.entity_id == n
                   and trigger.to_state is not none
                   and (trigger.to_state.attributes.get('package') or '') in sms_packages }}
          sequence:
            # DEBUG (keep for now): shows where THIS PHONE stores the SMS body
            - action: persistent_notification.create
              data:
                title: "Phone 2 SMS Debug"
                message: >
                  package={{ trigger.to_state.attributes.get('package') }}
                  title={{ trigger.to_state.attributes.get('android.title') }}
                  text={{ trigger.to_state.attributes.get('android.text') }}
                  bigText={{ trigger.to_state.attributes.get('android.bigText') }}
                  message={{ trigger.to_state.attributes.get('android.message') }}
                  state={{ trigger.to_state.state }}

            - variables:
                who: "{{ trigger.to_state.attributes.get('android.title') or 'Text' }}"
                txt_raw: >
                  {% set a = trigger.to_state.attributes %}
                  {% set msgs = a.get('android.messages') %}
                  {% if msgs is iterable and msgs|length > 0 and msgs[-1] is mapping and msgs[-1].get('text') %}
                    {{ msgs[-1].get('text') }}
                  {% else %}
                    {{ a.get('android.bigText')
                       or a.get('android.text')
                       or a.get('android.message')
                       or a.get('text')
                       or a.get('message')
                       or trigger.to_state.state
                       or '' }}
                  {% endif %}
                txt: "{{ txt_raw | replace('\n',' ') | replace('\r',' ') | trim | truncate(180, True, 'â€¦') }}"

            - condition: template
              value_template: "{{ txt|length > 0 }}"

            - action: tts.speak
              target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: "{{ speaker }}"
                message: "{{ prefix }}{{ who }}: {{ txt }}"
