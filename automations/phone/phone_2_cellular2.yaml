- id: '1767329000002'
  alias: Phone 2 - Cellular - TTS (Proven Pattern)
  description: >
    Phone 2 cellular events (proven pattern from Note9 working automation).

    Sensors:
    - Notifications: sensor.phone_2_last_notification
    - Phone state:  sensor.phone_2_phone_state

    This speaks:
    - Incoming call ringing (phone_state = ringing/incoming/offhook)
    - Carrier SMS texts from Samsung Messages app (package = com.samsung.android.messaging)
      (and also supports Google Messages if needed)
  triggers:
    - entity_id: sensor.phone_2_phone_state
      trigger: state
    - entity_id: sensor.phone_2_last_notification
      attribute: post_time
      trigger: state

  conditions: []

  actions:
    - choose:

        # 1) Incoming call
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.entity_id == 'sensor.phone_2_phone_state'
                   and trigger.to_state is not none
                   and trigger.to_state.state in ['ringing','incoming','offhook'] }}
          sequence:
            - action: tts.speak
              target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: media_player.amp_1
                message: "{{ prefix }}Phone is ringing."

        # 2) Cellular SMS (Samsung Messages; add Google Messages if you use it)
        - conditions:
            - condition: template
              value_template: >
                {{ trigger.entity_id == 'sensor.phone_2_last_notification'
                   and (state_attr('sensor.phone_2_last_notification','package') or '')
                      in ['com.samsung.android.messaging','com.google.android.apps.messaging'] }}
          sequence:
            - variables:
                n: sensor.phone_2_last_notification
                who: "{{ state_attr(n,'android.title') or 'Text' }}"
                txt_raw: >
                  {% set msgs = state_attr(n,'android.messages') %}
                  {% if msgs is iterable and msgs|length > 0 and msgs[-1] is mapping and 'text' in msgs[-1] %}
                    {{ msgs[-1].text }}
                  {% else %}
                    {{ state_attr(n,'android.text')
                       or state_attr(n,'android.bigText')
                       or state_attr(n,'android.message')
                       or '' }}
                  {% endif %}
                txt: "{{ txt_raw | replace('\n',' ') | replace('\r',' ') | trim | truncate(180, True, 'â€¦') }}"
            - condition: template
              value_template: "{{ txt|length > 0 }}"
            - action: tts.speak
              target:
                entity_id: tts.google_translate_en_com
              data:
                media_player_entity_id: media_player.amp_1
                message: "{{ prefix }}{{ who }}: {{ txt }}"

  mode: restart

  variables:
    phone_model: "Phone 2"
    prefix: "{{ phone_model }} Cellular: "
