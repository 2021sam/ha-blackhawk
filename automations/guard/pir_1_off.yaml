# PART 2 (PIR OFF) â€” start cooldown using a user-adjustable minutes helper

- id: guardian_01_pir_off
  alias: PIR Guardian - OFF - 1
  description: >
    PIR OFF: immediately play WAV only if cooldown is idle, then turn off light +
    power strip. Start cooldown ONLY at the end and ONLY if WAV played.
    Cooldown duration comes from input_number.audio_cooldown_minutes_1.

  triggers:
    - trigger: state
      entity_id: binary_sensor.sonoff_1_occupancy
      to: "off"

  variables:
    target_light: "{{ states('input_select.target_light_1') }}"
    audio_choice: "{{ states('input_select.audio_target_1') }}"
    did_wav: false
    cooldown_minutes: "{{ states('input_number.audio_cooldown_minutes_1') | int(5) }}"

  actions:
    # Play WAV (cooldown-gated) using helpers: None / All / media_player.*
    - choose:
        - conditions:
            - condition: state
              entity_id: timer.audio_cooldown_1
              state: idle
            - condition: template
              value_template: >
                {{ audio_choice not in ['None','none','off','unknown','unavailable',''] }}
          sequence:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ audio_choice in ['All','all','*'] }}"
                  sequence:
                    - action: media_player.play_media
                      target:
                        entity_id:
                          - media_player.amp_1
                          - media_player.amp_2
                      data:
                        media_content_id: /local/soundscapes/1.wav
                        media_content_type: music
              default:
                - action: media_player.play_media
                  target:
                    entity_id: "{{ audio_choice }}"
                  data:
                    media_content_id: /local/soundscapes/1.wav
                    media_content_type: music
            - variables:
                did_wav: true

    # Light OFF (guarded)
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {{ target_light not in ['unknown','unavailable','none','None',''] }}
          sequence:
            - action: light.turn_off
              target:
                entity_id: "{{ target_light }}"

    # Power strip OFF
    - action: homeassistant.turn_off
      target:
        entity_id: group.power_strip_1

    # Start cooldown ONLY if WAV played (duration from slider)
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ did_wav and cooldown_minutes > 0 }}"
          sequence:
            - action: timer.start
              target:
                entity_id: timer.audio_cooldown_1
              data:
                duration: "{{ '00:%02d:00' | format(cooldown_minutes) }}"

  mode: single
