- id: realtor_01_pir_on
  alias: Realtor 1 - PIR Trigger
  description: Realtor narration with volume control

  trigger:
    - platform: state
      entity_id: binary_sensor.sonoff_1_occupancy
      to: "on"

  action:

    # Turn ON selected target
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {{ is_light and target_entity not in ['unknown','unavailable','none','None',''] }}
            - condition: template
              value_template: >
                {{ is_state('input_boolean.guard_1_block_light_daytime','off')
                   or is_state('sun.sun','below_horizon') }}
          sequence:
            - service: light.turn_on
              target:
                entity_id: "{{ target_entity }}"

        - conditions:
            - condition: template
              value_template: >
                {{ is_power and target_entity not in ['unknown','unavailable','none','None',''] }}
          sequence:
            - service: homeassistant.turn_on
              target:
                entity_id: "{{ target_entity }}"

    # TTS WITH VOLUME CONTROL
    - choose:
        - conditions:
            - condition: state
              entity_id: timer.guard_1_audio_cooldown
              state: idle
            - condition: template
              value_template: >
                {{ audio_choice not in ['None','none','off','unknown','unavailable',''] }}
          sequence:

            # Set volume FIRST
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ audio_choice in ['All','all','*'] }}"
                  sequence:
                    - service: media_player.volume_set
                      target:
                        entity_id:
                          - media_player.amp_1
                          - media_player.amp_2
                      data:
                        volume_level: "{{ states('input_number.realtor_audio_volume') | float(0.5) }}"
              default:
                - service: media_player.volume_set
                  target:
                    entity_id: "{{ audio_choice }}"
                  data:
                    volume_level: "{{ states('input_number.realtor_audio_volume') | float(0.5) }}"

            # Speak
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ audio_choice in ['All','all','*'] }}"
                  sequence:
                    - service: tts.speak
                      target:
                        entity_id: tts.google_translate_en_com
                      data:
                        media_player_entity_id:
                          - media_player.amp_1
                          - media_player.amp_2
                        message: >
                          {% set realtor = states('input_text.realtor_custom_tts') %}
                          {{ realtor if realtor not in ['unknown','unavailable','none','None',''] else 'Welcome.' }}
              default:
                - service: tts.speak
                  target:
                    entity_id: tts.google_translate_en_com
                  data:
                    media_player_entity_id: "{{ audio_choice }}"
                    message: >
                      {% set realtor = states('input_text.realtor_custom_tts') %}
                      {{ realtor if realtor not in ['unknown','unavailable','none','None',''] else 'Welcome.' }}

    # Update timestamp
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.guard_1_last_motion_time
      data:
        datetime: "{{ now() }}"

  variables:
    target_entity: "{{ states('input_select.guard_1_target_light') }}"
    is_light: "{{ target_entity.startswith('light.') }}"
    is_power: "{{ target_entity.startswith('group.') or target_entity.startswith('switch.') }}"
    audio_choice: "{{ states('input_select.guard_1_audio_target') }}"

  mode: restart
